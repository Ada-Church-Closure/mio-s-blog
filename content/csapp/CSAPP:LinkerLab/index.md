+++
date = '2025-04-19T16:27:09+08:00'
draft = false
title = 'CSAPP:LinkerLab'

+++

# CSAPP:LinkerLab

> CSAPPä¸Šå…³äºé“¾æ¥çš„çŸ¥è¯†æˆ‘ä¹Ÿä¼šæ”¾åœ¨è¿™é‡Œ......
>
> æœ¬æ–‡å›¾ç‰‡å¤§å¤šæ¥æºäºè‹±æ–‡åŸç‰ˆCSAPPã€‚

## é“¾æ¥æœºåˆ¶è¯¦è§£

> â€‹	æœ‰å¤šè¯¦ç»†ï¼Ÿè¿™å¾ˆéš¾å®šä¹‰å§ï¼Œæ˜¯å¦è¯¦ç»†åº”å½“å–å†³äºè¯»è€…æœ¬æ¥çš„ç†è§£,linkingæœ¬èº«å°±æ˜¯çœ‹èµ·æ¥å¥½åƒå°±æ˜¯æ‰“åŒ…ä¸€ä¸‹å¾ˆç®€å•çš„ä¸œè¥¿ï¼Œä½†æ˜¯æ¶‰åŠåˆ°çš„çŸ¥è¯†æ¯”è¾ƒå¤æ‚ï¼Œåº”ç”¨ä¹Ÿç›¸å½“å¹¿æ³›ã€‚

### ç¼–è¯‘å™¨é©±åŠ¨ç¨‹åº

ä¸€ä¸ªé™æ€é“¾æ¥è¿‡ç¨‹ï¼š

![image-20250408194000629](/img/image-20250408194000629.png)

### é™æ€é“¾æ¥

LD é™æ€é“¾æ¥å™¨ è¾“å…¥.oæ–‡ä»¶ è¾“å‡ºä¸€ä¸ªå¯æ‰§è¡Œæ–‡ä»¶

1.ç¬¦å·çš„è§£æ

2.é‡æ–°å®šä½

### ç›®æ ‡æ–‡ä»¶

1.å¯é‡å®šä½

2.å¯æ‰§è¡Œ

3.å…±äº«ï¼ˆå¯ä»¥åŠ¨æ€åŠ è½½è¿›å…¥å†…å­˜å¹¶ä¸”linkï¼‰

### å¯é‡å®šä½ç›®æ ‡æ–‡ä»¶

**æ„æ€å°±æ˜¯è¿™ä¸ªæ–‡ä»¶ä½œä¸ºä¸€ä¸ªç›®æ ‡æ–‡ä»¶ï¼Œå¯ä»¥ç”¨æ¥é‡å®šä½ã€‚**

å¾ˆå¤šäººå¼€å§‹åŒºåˆ†ä¸æ¸…æ¥š.oå’Œelfï¼šelfå°±æ˜¯ä¸€ç§æ ¼å¼

åŒ…å«çš„å†…å®¹ï¼š

![image-20250616170825010](/img/image-20250616170825010.png)

- ELF å…¨ç§°æ˜¯ **Executable and Linkable Formatï¼ˆå¯æ‰§è¡Œä¸å¯é“¾æ¥æ ¼å¼ï¼‰**
- æ˜¯ Linux ç³»ç»Ÿä¸­å¸¸ç”¨çš„**ç›®æ ‡æ–‡ä»¶æ ¼å¼**ï¼ˆWindows ä¸Šç”¨çš„æ˜¯ PE æ ¼å¼ï¼‰
- ä¸€ä¸ª ELF æ–‡ä»¶å¯ä»¥æ˜¯ï¼š
  - **å¯é‡å®šä½ç›®æ ‡æ–‡ä»¶ï¼ˆRelocatable Object Fileï¼‰** â†’ `.o` æ–‡ä»¶
  - **å¯æ‰§è¡Œæ–‡ä»¶ï¼ˆExecutable Fileï¼‰** â†’ å¦‚é€šè¿‡é“¾æ¥ç”Ÿæˆçš„å¯æ‰§è¡Œç¨‹åº
  - **å…±äº«åº“æ–‡ä»¶ï¼ˆShared Object Fileï¼‰** â†’ `.so` æ–‡ä»¶
  - **æ ¸å¿ƒè½¬å‚¨æ–‡ä»¶ï¼ˆCore Dumpï¼‰** â†’ ç¨‹åºå´©æºƒæ—¶ç”Ÿæˆçš„è°ƒè¯•æ–‡ä»¶

- `.o` æ–‡ä»¶æ˜¯ç”¨ç¼–è¯‘å™¨ï¼ˆå¦‚ `gcc -c`ï¼‰ä» `.c` æ–‡ä»¶ç”Ÿæˆçš„
- `.o` æ–‡ä»¶çš„æ ¼å¼å°±æ˜¯ **ELF æ ¼å¼çš„â€œå¯é‡å®šä½ç›®æ ‡æ–‡ä»¶â€**
- å®ƒé€šå¸¸è¿˜ä¸åŒ…å«ä¸»å‡½æ•°ï¼ˆ`main()`ï¼‰ï¼Œä¸èƒ½ç›´æ¥è¿è¡Œï¼Œéœ€è¦**é“¾æ¥æˆå¯æ‰§è¡Œæ–‡ä»¶**

ä¸€ä¸ªå…¸å‹çš„æ ¼å¼å¦‚ä¸‹ï¼š

![image-20250408195710553](/img/image-20250408195710553.png)

.text:æœºå™¨ä»£ç 

.rodata:åªè¯»data

.data:å…¨å±€ é™æ€å˜é‡

.bss:æœªåˆå§‹åŒ–æˆ–è€…åˆå§‹åŒ–ä¸º0çš„å…¨å±€é™æ€(**better save space**(?))

.symtab:ç¬¦å·è¡¨ï¼Œå‡½æ•°å’Œå…¨å±€å˜é‡çš„ä¿¡æ¯

â€‹	æˆ‘ä»¬ç”¨**readelf**å·¥å…·å»è¯»å–å¤´æ–‡ä»¶çš„å†…å®¹ï¼Œå¹¶ä¸”åˆ†æä¸€ä¸‹è¿™ä¸ªå†…å®¹ï¼š

![image-20250616171110203](/img/image-20250616171110203.png)

ä»€ä¹ˆæ˜¯**Magic** **Number**ï¼š**æ ‡è¯†äº†è¿™ä¸ªå¯é‡å®šä½ç›®æ ‡æ–‡ä»¶**ï¼š

![image-20250616171305797](/img/image-20250616171305797.png)



æ ¹æ®ä¸Šè¿°çš„ä¿¡æ¯ï¼Œå¯ä»¥å¾—åˆ°ï¼š

![image-20250616172117252](/img/image-20250616172117252.png)

é‚£ä¹ˆsectionä¸­å­˜æ”¾çš„ï¼š

![image-20250616172756539](/img/image-20250616172756539.png)

å°±å¦‚æˆ‘ä»¬ä¸Šé¢æ‰€æåˆ°çš„ã€‚

### ç¬¦å·å’Œç¬¦å·è¡¨

> ***ç¬¦å·è¡¨**æ˜¯é‡ç‚¹å†…å®¹ã€‚

æ¯ä¸ª**å¯é‡å®šä½æ¨¡å—m**éƒ½æœ‰ä¸€ä¸ª**ç¬¦å·è¡¨**ï¼Œè¿™ä¸ªsymbol tableå°±åœ¨sectionä¸­ã€‚

1.å…¨å±€ç¬¦å· æˆ‘å®šä¹‰çš„**éé™æ€Cå‡½æ•°**å’Œ**å…¨å±€å˜é‡**ã€‚

2.å¤–éƒ¨ç¬¦å· åˆ«äººå®šä¹‰çš„**éé™æ€Cå‡½æ•°**å’Œ**å…¨å±€å˜é‡**ã€‚

3.**å±€éƒ¨ç¬¦**å· æˆ‘çš„**staticå‡½æ•°**å’Œå±€éƒ¨å˜é‡ï¼ˆ.symtabä¸å…³å¿ƒè¿™äº›ä¸œè¥¿ï¼‰,ç›´æ¥åœ¨**stack**ä¸­ç®¡ç†ã€‚

> æ‰€ä»¥ï¼Œåœ¨Cè¯­è¨€å¤šæ–‡ä»¶ç¼–ç¨‹ä¸­ï¼Œç”¨**staticä¿æŠ¤å¥½è‡ªå·±çš„å‡½æ•°å’Œå˜é‡**æ˜¯å¥½çš„ä¹ æƒ¯ã€‚
>
> ä¸ä¼šè¢«åˆ«äººå¼•ç”¨ï¼ˆæ˜æ˜æ˜¯æˆ‘å…ˆæ¥çš„ï¼ï¼ï¼ï¼‰

**ç¬¦å·è¡¨æ¡ç›®**ï¼š

![image-20250408202046410](/img/image-20250408202046410.png)

æ¯ä¸ªå­—æ®µéƒ½è¢«åˆ†é…åˆ°ç›®æ ‡æ–‡ä»¶çš„æŸä¸ªsection

ç”¨ **readelf** æŸ¥çœ‹ç›®æ ‡æ–‡ä»¶å†…å®¹

| é€‰é¡¹ | å«ä¹‰ |
| ---- | ---- |
|      |      |

| `-h` | æŸ¥çœ‹ ELF æ–‡ä»¶å¤´ï¼ˆHeaderï¼‰ |
| ---- | ------------------------- |
|      |                           |

| `-S` | æŸ¥çœ‹æ®µè¡¨ï¼ˆSection Headersï¼‰ |
| ---- | --------------------------- |
|      |                             |

| `-s` | æŸ¥çœ‹ç¬¦å·è¡¨ï¼ˆSymbol Tableï¼‰ |
| ---- | -------------------------- |
|      |                            |

| `-r` | æŸ¥çœ‹é‡å®šä½ä¿¡æ¯ï¼ˆRelocation Infoï¼‰ |
| ---- | --------------------------------- |
|      |                                   |

| `-l` | æŸ¥çœ‹ç¨‹åºå¤´è¡¨ï¼ˆProgram Headerï¼‰ |
| ---- | ------------------------------ |
|      |                                |

| `-x <section>` | ä»¥åå…­è¿›åˆ¶æŸ¥çœ‹æŸä¸ªæ®µçš„å†…å®¹ |
| -------------- | -------------------------- |
|                |                            |

| `-a` | æŸ¥çœ‹æ‰€æœ‰ä¿¡æ¯ï¼ˆç­‰ä»·äºæ‰€æœ‰é€‰é¡¹çš„åˆé›†ï¼‰ |
| ---- | ------------------------------------ |
|      |                                      |

main.c

```C
int sum(int *a, int n);

int array[2] = {1, 2};

int main()
{
    int val = sum(array, 2);
    return val;
}
```

sum.c

```C
int sum(int *a, int n)
{
    int i, s = 0;
    for (i = 0; i < n; i++)
    {
        s += a[i];
    }
    return s;
}
```

```shell
$readelf -s main.o
```

```shell
Symbol table '.symtab' contains 6 entries:
   Num:    Value          Size Type    Bind   Vis      Ndx Name
     0: 0000000000000000     0 NOTYPE  LOCAL  DEFAULT  UND 
     1: 0000000000000000     0 FILE    LOCAL  DEFAULT  ABS main.c
     2: 0000000000000000     0 SECTION LOCAL  DEFAULT    1 .text
     3: 0000000000000000     8 OBJECT  GLOBAL DEFAULT    3 array
     4: 0000000000000000    40 FUNC    GLOBAL DEFAULT    1 main
     5: 0000000000000000     0 NOTYPE  GLOBAL DEFAULT  UND sum
```

> æœ‰ç‚¹æ‡µï¼ŒåŠ¡å¿…åšè¯¾åç»ƒä¹ é¢˜è¿›ä¸€æ­¥ç†è§£ã€‚

### ç¬¦å·è§£æ

> é“¾æ¥å™¨æ˜¯æ€æ ·å·¥ä½œçš„ï¼Ÿ

*å¯¹äºæ¯ä¸ªè¾“å…¥çš„æ–‡ä»¶çš„ç¬¦å·è¡¨è¿›è¡Œæ‰«æã€‚*

#### å¤šé‡å®šä¹‰çš„å…¨å±€ç¬¦å·ï¼Ÿ

å…¨å±€---ã€‹å¼º å¼±

å¼ºç¬¦å·ï¼šå‡½æ•° **å·²ç»åˆå§‹åŒ–çš„å…¨å±€å˜é‡**

å¼±ç¬¦å·ï¼š**æœªåˆå§‹åŒ–çš„å…¨å±€å˜é‡**

**è§„åˆ™ï¼š**

1.å¼ºä¸èƒ½é‡å

2.ä¸€å¼ºå¤šå¼±é€‰å¼ºç¬¦å·

3.å¤šä¸ªå¼±ç¬¦å·éšæœºé€‰æ‹©ï¼ˆ**2,3éƒ½æ˜¯æ¯”è¾ƒå±é™©çš„æƒ…å†µ**ï¼‰

-fno-common:é‡åˆ°å¤šé‡å®šä¹‰çš„å…¨å±€ç¬¦å·ç›´æ¥è§¦å‘é”™è¯¯ï¼Œæ¯”è¾ƒä¿é™©ã€‚

æ˜¯æ¯”è¾ƒå¥½ç†è§£çš„éƒ¨åˆ†ã€‚

#### ä¸é™æ€åº“çš„é“¾æ¥ï¼Ÿ

â€‹	é™æ€åº“ä½œä¸ºå­˜æ¡£ï¼ˆarchieveï¼‰å­˜æ”¾åœ¨ç£ç›˜ä¸­ï¼Œå¯ä»¥è®¤ä¸ºæ˜¯ä¸€ç»„å¯é‡å®šä½ç›®æ ‡æ–‡ä»¶çš„é›†åˆï¼Œå½“æˆ‘ä»¬è‡ªå·±çš„ç¼–ç¨‹ä¸­å¼•ç”¨åº“æ—¶å°±å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![image-20250415195916810](/img/image-20250415195916810.png)

å½“ä½ å¼•ç”¨addvecæ—¶ï¼Œç›´æ¥å¤åˆ¶addvec.oåˆ°å¯æ‰§è¡Œçš„æ–‡ä»¶ã€‚

![image-20250616201136313](/img/image-20250616201136313.png)

#### å¦‚ä½•ä½¿ç”¨é™æ€åº“è§£æå¼•ç”¨ï¼Ÿ

å¯¹äºä¸€è¡Œç¼–è¯‘çš„å‘½ä»¤ï¼Œlinkerä¼šä»å·¦åˆ°å³è¿›è¡Œæ‰«æï¼Œç»´æŠ¤ä¸‰ä¸ªé›†åˆï¼š

1.Eï¼šç»´æŠ¤å¯é‡å®šä½ç›®æ ‡æ–‡ä»¶çš„é›†åˆ

2.Uï¼šæœªè§£æçš„ç¬¦å·çš„é›†åˆ

3.Dï¼šå‰é¢è¾“å…¥æ–‡ä»¶çš„å·²ç»å®šä¹‰çš„ç¬¦å·çš„é›†åˆ

**processï¼š**

1.æ‰«æè¿‡ç¨‹ä¸­ï¼Œè‹¥ä¸ºä¸€ä¸ªç›®æ ‡æ–‡ä»¶fï¼Œç›´æ¥æ”¾å…¥Eä¸­ï¼Œå¹¶ä¸”åœ¨Uå’ŒDä¸­æ›´æ”¹å…ƒç´ ï¼ˆæ¯”å¦‚è‡ªå·±å®šä¹‰çš„ç¬¦å·å°±æ”¾åˆ°Dï¼Œæ­¤æ—¶å¼•ç”¨çš„é™æ€åº“çš„ç¬¦å·å°±æ”¾åˆ°Uï¼‰ã€‚

2.è‹¥fæ˜¯ä¸€ä¸ªarchieveï¼Œé‚£ä¹ˆæˆ‘ä»¬å°†archiveä¸­çš„æˆå‘˜å’ŒUä¸­çš„å…ƒç´ æ¯”å¯¹ï¼Œå¦‚æœå®šä¹‰äº†ï¼Œå°±æŠŠè¿™ä¸ªå…ƒç´ æ”¾åˆ°Dä¸­å»ã€‚

3.linkerå®Œæˆä¹‹åï¼Œ|U| ï¼= 0 ï¼Œé‚£ä¹ˆæŠ¥é”™ä¸­æ­¢ã€‚

```shell
unix> gcc -static ./libvector.a main2.c
/tmp/cc9XH6Rp.o: In function â€˜mainâ€™:
/tmp/cc9XH6Rp.o(.text+0x18): undefined reference to â€˜addvecâ€™
```

â€‹	é‚£ä¹ˆè€ƒå¯Ÿè¿™æ ·çš„æƒ…å†µï¼Œè‹¥ä½ æŠŠé™æ€åº“æ”¾åˆ°å‰é¢ï¼Œé‚£ä¹ˆå¼€å§‹å°±ä¼šå’ŒUä¸­çš„å…ƒç´ æ¯”å¯¹ï¼Œä½†æ˜¯æ­¤æ—¶Uä¸­æ²¡æœ‰å…ƒç´ ï¼Œå½“main.cè¢«æ‰«ææ—¶ï¼Œæ­¤æ—¶å®ƒå¼•ç”¨çš„é™æ€åº“ä¸­çš„å‡½æ•°å°±ä¼šæ˜¯**undefined**ã€‚

> æ‰€ä»¥æˆ‘ä»¬è¦æŠŠ**åº“æ”¾åœ¨æœ€åï¼Œå¹¶ä¸”è¦æ ¹æ®åº“ä¹‹é—´çš„ä¾èµ–å‹è¿›è¡Œæ’åºï¼ˆæ‹“æ‰‘æ’åºï¼‰**ã€‚
>
> å¦‚æœæœ‰æ›´å¤æ‚çš„ä¾èµ–æ€§é—®é¢˜ï¼Œå°±å¯ä»¥å¤šæ¬¡åœ¨å‘½ä»¤è¡Œä¸Š**é‡å¤åº“**ï¼ˆå¯ä»¥çœ‹è¯¾åé¢˜ç›®ï¼‰ã€‚
>
> å¦‚ä¸‹å›¾æ‰€ç¤ºçš„è¿‡ç¨‹ï¼š

![image-20250616201457592](/img/image-20250616201457592.png)

### é‡å®šä½

> å°±æ˜¯æ›´æ¢åœ°å€ã€‚

åˆå¹¶è¾“å…¥æ¨¡å—ï¼Œä¸ºæ¯ä¸ªç¬¦å·**åˆ†é…è¿è¡Œ**æ—¶åœ°å€ã€‚

1.é‡å®šä½èŠ‚å’Œ**ç¬¦å·å®šä¹‰**

â€‹	æ¯”å¦‚æŠŠæ‰€æœ‰çš„**.data**èŠ‚åˆå¹¶æˆä¸€ä¸ªèŠ‚å¹¶ä¸”**åˆ†é…åœ°å€**ã€‚

2.é‡å®šä½èŠ‚ä¸­çš„**ç¬¦å·å¼•ç”¨**

â€‹	ä¿®æ”¹ç¬¦å·å¼•ç”¨ï¼Œä½¿å…¶æŒ‡å‘æ­£ç¡®çš„è¿è¡Œæ—¶åœ°å€ã€‚

#### é‡å®šä½æ¡ç›®

**æ±‡ç¼–å™¨**ç”Ÿæˆç›®æ ‡æ¨¡å—æ—¶ç”Ÿæˆ.rel.data .rel.text é‡å®šä½æ¡ç›®

![image-20250417193235496](/img/image-20250417193235496.png)

#### é‡å®šä½ç¬¦å·å¼•ç”¨

é‡å®šä½ç®—æ³•éå†æ¯ä¸ªsectionå’Œéå†æ¯ä¸ªæ¡ç›®ï¼š

```c
foreach section s {
foreach relocation entry r {
	refptr = s + r.offset; /* ptr to reference to be relocated */
	/* relocate a PC-relative reference */
    //ç›¸å¯¹åœ°å€
	if (r.type == R_386_PC32) {
	refaddr = ADDR(s) + r.offset; /* refâ€™s runtime address */
	*refptr = (unsigned) (ADDR(r.symbol) + *refptr - refaddr);
	}
    //ç»å¯¹åœ°å€
	/* relocate an absolute reference */
	if (r.type == R_386_32){
	*refptr = (unsigned) (ADDR(r.symbol) + *refptr);
	}
}
}
```

å¯¹äºä¸Šé¢çš„main.o åš

objdump -dx main.o

```livescript
Disassembly of section .text:

0000000000000000 <main>:
   0:   f3 0f 1e fa             endbr64 
   4:   55                      push   %rbp
   5:   48 89 e5                mov    %rsp,%rbp
   8:   48 83 ec 10             sub    $0x10,%rsp
   c:   be 02 00 00 00          mov    $0x2,%esi
  11:   48 8d 05 00 00 00 00    lea    0x0(%rip),%rax        # 18 <main+0x18>
                        14: R_X86_64_PC32       array-0x4
  18:   48 89 c7                mov    %rax,%rdi
  1b:   e8 00 00 00 00          call   20 <main+0x20>
                        1c: R_X86_64_PLT32      sum-0x4
  20:   89 45 fc                mov    %eax,-0x4(%rbp)
  23:   8b 45 fc                mov    -0x4(%rbp),%eax
  26:   c9                      leave  
  27:   c3                      ret    
```

è¿™æ˜¯æˆ‘ç”µè„‘ä¸Šå®é™…è¿è¡Œçš„ç»“æœï¼Œarrayå’Œsuméƒ½æ˜¯**é‡å®šä½PCç›¸å¯¹å¼•ç”¨**

#### é‡å®šä½PCç›¸å¯¹å¼•ç”¨

```livescript
  1b:   e8 00 00 00 00          call   20 <main+0x20>
```

è§‚å¯Ÿè¿™ä¸€è¡Œï¼Œe8æ˜¯callçš„æ“ä½œç ï¼Œåé¢çš„00 00 00 00 éƒ½æ˜¯PCç›¸å¯¹å¼•ç”¨çš„å ä½ç¬¦ã€‚

åœ¨é‡å®šä½æ—¶ï¼Œåˆ©ç”¨ä¸Šè¿°çš„ç®—æ³•ï¼Œå‘Šè¯‰æˆ‘ä»¬sumåœ¨mainä¸­çš„åç§»é‡ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨è¿™é‡Œè°ƒç”¨åˆ°sumã€‚

æ±‚ä¸¤ä¸ªåœ°å€ä¹‹é—´çš„ç›¸å¯¹ä½ç½®ï¼š

![](/img/image-20250616202744519.png)

#### é‡å®šä½ç»å¯¹å¼•ç”¨

åœ¨ç›®æ ‡æ–‡ä»¶ä¸­ç›´æ¥è®¡ç®—å¹¶ä¸”æ›´æ”¹ã€‚

åœ¨æˆ‘ä»¬é‡å®šä½ä¹‹åï¼š

```objc
0000000000001129 <main>:
    1129:       f3 0f 1e fa             endbr64 
    112d:       48 83 ec 08             sub    $0x8,%rsp
    1131:       be 02 00 00 00          mov    $0x2,%esi
    1136:       48 8d 3d d3 2e 00 00    lea    0x2ed3(%rip),%rdi        # 4010 <array>
    113d:       e8 05 00 00 00          call   1147 <sum>
    1142:       48 83 c4 08             add    $0x8,%rsp
    1146:       c3                      ret    

0000000000001147 <sum>:
    1147:       f3 0f 1e fa             endbr64 
    114b:       ba 00 00 00 00          mov    $0x0,%edx
    1150:       b8 00 00 00 00          mov    $0x0,%eax
    1155:       eb 09                   jmp    1160 <sum+0x19>
    1157:       48 63 c8                movslq %eax,%rcx
    115a:       03 14 8f                add    (%rdi,%rcx,4),%edx
    115d:       83 c0 01                add    $0x1,%eax
    1160:       39 f0                   cmp    %esi,%eax
    1162:       7c f3                   jl     1157 <sum+0x10>
    1164:       89 d0                   mov    %edx,%eax
    1166:       c3                      ret    
```

mainä¸­113eçš„ä½ç½®å°±æ˜¯sumçš„é‡å®šä½åœ°å€ã€‚

è¿™é‡Œçš„å€¼5å°±æ˜¯é‡å®šä½çš„å€¼ï¼šå½“CPUæ‰§è¡ŒcallæŒ‡ä»¤æ—¶ï¼ŒPCä¼šæŒ‡å‘ä¸‹ä¸€æ¡å°±æ˜¯1142,ä¸ºäº†æ‰§è¡Œè¿™ä¸ªæŒ‡ä»¤ï¼ŒCPUæŠŠPCæ”¾è¿›æ ˆä¸­ï¼Œå¹¶ä¸” PC += 5ï¼Œä¹Ÿå°±æ˜¯PC = 1147ï¼Œæ­¤æ—¶ï¼Œå°±ä¼šæ‰§è¡Œåˆ°sumçš„ä»£ç ã€‚

è¿™ä¸ªé€»è¾‘æ˜¯å’ŒcallæŒ‡ä»¤é…å¥—çš„ï¼Œlinkeråœ¨ğŸ”—è¿™ä¸¤ä¸ªç¨‹åºçš„æ—¶å€™ï¼Œå°±ä¼šæ ¹æ®é‡å®šä½è¡¨ï¼ŒæŠŠe8ä¹‹åçš„å ä½ç¬¦æ›´æ”¹æˆè¦è°ƒç”¨çš„å‡½æ•°ç›¸å¯¹äºå½“å‰PCçš„åç§»é‡çš„å¤§å°ï¼Œcallä¼šå…ˆå°†PCå‹å…¥æ ˆä¸­ï¼ŒPC += offsetï¼Œæ¥ç€å°±ä¼šæ‰§è¡Œåˆ°ç›®æ ‡å‡½æ•°ã€‚

### å¯æ‰§è¡Œç›®æ ‡æ–‡ä»¶

æˆ‘ä»¬ç°åœ¨å·²ç»åˆæˆäº†è¿™ä¸ªï¼š

![image-20250417203201689](/img/image-20250417203201689.png)

è¿™æ˜¯ä¸€ä¸ªå…¸å‹çš„æ ¼å¼ã€‚

æˆ‘ä»¬æŸ¥çœ‹ä¸€ä¸‹ä¸Šé¢é‚£ä¸ªa.outçš„program header

```objc
Program Header:
    PHDR off    0x0000000000000040 vaddr 0x0000000000000040 paddr 0x0000000000000040 align 2**3
         filesz 0x00000000000002d8 memsz 0x00000000000002d8 flags r--
  INTERP off    0x0000000000000318 vaddr 0x0000000000000318 paddr 0x0000000000000318 align 2**0
         filesz 0x000000000000001c memsz 0x000000000000001c flags r--
    LOAD off    0x0000000000000000 vaddr 0x0000000000000000 paddr 0x0000000000000000 align 2**12
         filesz 0x00000000000005f0 memsz 0x00000000000005f0 flags r--
    LOAD off    0x0000000000001000 vaddr 0x0000000000001000 paddr 0x0000000000001000 align 2**12
         filesz 0x0000000000000175 memsz 0x0000000000000175 flags r-x
    LOAD off    0x0000000000002000 vaddr 0x0000000000002000 paddr 0x0000000000002000 align 2**12
         filesz 0x00000000000000d8 memsz 0x00000000000000d8 flags r--
    LOAD off    0x0000000000002df0 vaddr 0x0000000000003df0 paddr 0x0000000000003df0 align 2**12
         filesz 0x0000000000000228 memsz 0x0000000000000230 flags rw-
 DYNAMIC off    0x0000000000002e00 vaddr 0x0000000000003e00 paddr 0x0000000000003e00 align 2**3
         filesz 0x00000000000001c0 memsz 0x00000000000001c0 flags rw-
    NOTE off    0x0000000000000338 vaddr 0x0000000000000338 paddr 0x0000000000000338 align 2**3
         filesz 0x0000000000000030 memsz 0x0000000000000030 flags r--
    NOTE off    0x0000000000000368 vaddr 0x0000000000000368 paddr 0x0000000000000368 align 2**2
         filesz 0x0000000000000044 memsz 0x0000000000000044 flags r--
0x6474e553 off    0x0000000000000338 vaddr 0x0000000000000338 paddr 0x0000000000000338 align 2**3
         filesz 0x0000000000000030 memsz 0x0000000000000030 flags r--
EH_FRAME off    0x0000000000002004 vaddr 0x0000000000002004 paddr 0x0000000000002004 align 2**2
         filesz 0x0000000000000034 memsz 0x0000000000000034 flags r--
   STACK off    0x0000000000000000 vaddr 0x0000000000000000 paddr 0x0000000000000000 align 2**4
         filesz 0x0000000000000000 memsz 0x0000000000000000 flags rw-
   RELRO off    0x0000000000002df0 vaddr 0x0000000000003df0 paddr 0x0000000000003df0 align 2**0
         filesz 0x0000000000000210 memsz 0x0000000000000210 flags r--
```

åé¢çš„æ˜¯æ‰§è¡Œçš„æƒé™çš„é—®é¢˜ï¼Œvaddræ˜¯å¼€å§‹çš„å†…å­˜åœ°å€ï¼Œmemszæ˜¯æ€»å…±çš„å†…å­˜å¤§å°ï¼Œoffåç§»é‡ï¼Œæˆ‘ä»¬è¦æ»¡è¶³è¿™æ ·çš„æ¡ä»¶ï¼š

â€‹								**vaddr mod align = off mod align** 

è¿™æ ·ç¨‹åºæ‰§è¡Œçš„æ—¶å€™ï¼Œå¯ä»¥æœ‰æ•ˆç‡çš„ä¼ é€åˆ°å†…å­˜ï¼Œæˆ‘ä»¬ä¼šåœ¨è™šæ‹Ÿå†…å­˜çš„ç« èŠ‚ä¸­å­¦ä¹ åˆ°ã€‚

###  åŠ è½½å¯æ‰§è¡Œç›®æ ‡æ–‡ä»¶

> æˆ‘ä»¬å¯èƒ½è¿˜ä¼šæœ‰ä¸€ä¸ªå…³äºåŠ è½½å™¨çš„å®éªŒï¼Œç»§ç»­ç†è§£è¿™ä¸ªè¿‡ç¨‹ã€‚

./prog

â€‹	è¿™æ ·æˆ‘ä»¬æ¥è¿è¡Œä¸€ä¸ªè‡ªå·±å†™çš„ç¨‹åºï¼ŒloaderæŠŠä»£ç å’Œæ•°æ®å¤åˆ¶åˆ°å†…å­˜ä¸­ï¼Œå¹¶ä¸”è·³è½¬åˆ°å†…å­˜çš„ç¬¬ä¸€æ¡æŒ‡ä»¤æˆ–è€…å…¥å£ç‚¹ï¼Œè¿™ä¸ªå¤åˆ¶çš„è¿‡ç¨‹å°±å« **åŠ è½½ï¼ˆLoadï¼‰**ã€‚

â€‹	æ¯ä¸ªlinuxç¨‹åºéƒ½æœ‰ä¸€ä¸ªè¿è¡Œæ—¶å†…å­˜æ˜ åƒã€‚

![image-20250419155903953](/img/image-20250419155903953.png)

> æˆ‘ä»¬å¯¹äºåŠ è½½çš„æè¿°ä»æ¦‚å¿µä¸Šæ¥è¯´æ˜¯æ­£ç¡®çš„ï¼Œä½†ä¹Ÿä¸æ˜¯å®Œå…¨å‡†ç¡®ï¼Œè¿™æ˜¯æœ‰æ„ä¸ºä¹‹ã€‚
> è¦ç†è§£åŠ è½½å®é™…æ˜¯å¦‚ä½•å·¥ä½œçš„ ï¼Œä½ å¿…é¡»ç†è§£**è¿›ç¨‹ ã€è™šæ‹Ÿå†…å­˜å’Œå†…å­˜æ˜ å°„**çš„æ¦‚å¿µï¼Œè¿™äº›æˆ‘ä»¬è¿˜æ²¡æœ‰åŠ ä»¥è®¨è®º ã€‚åœ¨åé¢ç¬«8ç« å’Œç¬«9ç« ä¸­é‡åˆ°è¿™äº›æ¦‚å¿µæ—¶ ï¼Œæˆ‘ä»¬å°†é‡æ–°å›åˆ°åŠ è½½çš„é—®é¢˜ä¸Šï¼Œå¹¶é€æ¸å‘ä½ æ­å¼€å®ƒçš„**ç¥ç§˜é¢çº±**ã€‚

## å®éªŒï¼š

![https://xjtu-ics.github.io/assets/images/linklab/compiler_driver.png](/img/compiler_driver.png)

æœ¬å®éªŒå°±æ˜¯æ¨¡ä»¿ldï¼Œå†™ä¸€ä¸ªé™æ€çš„linkerï¼Œç±»ä¼¼äºlinuxçš„ldå·¥å…·ã€‚

ç”¨ç®€å•çš„cppå°±å¯ä»¥ã€‚

ä¸ºä»€ä¹ˆè¦linkerï¼šä¸ºæºä»£ç çš„æ¨¡å—åŒ–æä¾›å¯ä»¥ç›¸äº’å¼•ç”¨çš„æ¥å£ï¼ˆexternï¼‰ã€‚

![https://xjtu-ics.github.io/assets/images/linklab/linker-workflow.png](/img/linker-workflow.png)

1.ç¬¦å·è§£æï¼šä¸ºæ¯ä¸ªå¤–éƒ¨æ–‡ä»¶çš„ç¬¦å·å¼•ç”¨æ‰¾å¯¹åº”çš„è§£æã€‚

2.åˆå¹¶æˆä¸€ä¸ªå¯æ‰§è¡Œæ–‡ä»¶ã€‚

3.é‡å®šä½ï¼Œä¿®æ”¹å¯æ‰§è¡Œæ–‡ä»¶ä»£ç ï¼Œä½¿å…¶æŒ‡å‘æ­£ç¡®çš„ä½ç½®ã€‚

![https://xjtu-ics.github.io/assets/images/linklab/relocation-workflow.png](/img/relocation-workflow.png)

CPUä½¿ç”¨PCç›¸å¯¹å¼•ç”¨è®¿é—®åœ°å€ã€‚

é‡å®šä½å°±æ˜¯åœ¨åˆå¹¶ä¹‹åï¼Œåœ¨è¿™äº›ç©ºç¼ºçš„ä½ç½®å¡«å…¥åœ°å€ã€‚

å®éªŒæ¡†æ¶ï¼š

![https://xjtu-ics.github.io/assets/images/linklab/framework-workflow.png](/img/framework-workflow.png)

æˆ‘ä»¬è¦å®ç°çš„å°±æ˜¯è§£æå’Œé‡å®šä½è¿™ä¸¤ä¸ªå…³é”®è¿‡ç¨‹ã€‚

ç†è§£å…³é”®çš„æ•°æ®ç»“æ„ï¼š

#### ObjectFile

ç”¨æ¥å­˜å‚¨ç›®æ ‡æ–‡ä»¶ä¸­æ‰€éœ€çš„ä¿¡æ¯ï¼Œå…¶åŒ…å«çš„æˆå‘˜å˜é‡åŠå…¶å«ä¹‰å¦‚ä¸‹ï¼š

- symbolTable ï¼šç›®æ ‡æ–‡ä»¶çš„ç¬¦å·è¡¨ï¼Œä¿å­˜å…¶æ¯ä¸€ä¸ªç¬¦å·ï¼ˆè§ä¸‹æ–‡Symbolï¼‰
- relocTable ï¼šç›®æ ‡æ–‡ä»¶çš„é‡å®šä½è¡¨ï¼Œä¿å­˜å…¶æ¯ä¸€ä¸ªé‡å®šä½æ¡ç›®ï¼ˆè§ä¸‹æ–‡RelocEntryï¼‰
- sections ï¼šç›®æ ‡æ–‡ä»¶çš„èŠ‚è¡¨ï¼Œä¿å­˜èŠ‚åstringåˆ°èŠ‚çš„æ˜ å°„ï¼ˆè§ä¸‹æ–‡Sectionï¼‰
- sectionsByIdx ï¼šç›®æ ‡æ–‡ä»¶çš„èŠ‚è¡¨ï¼Œä¿å­˜èŠ‚ç´¢å¼•indexåˆ°èŠ‚æŒ‡é’ˆSection*çš„æ˜ å°„
- baseAddr ï¼šç›®æ ‡æ–‡ä»¶åœ¨å†…å­˜ä¸­çš„èµ·å§‹åœ°å€ï¼Œè¯¦è§test0
- size ï¼šç›®æ ‡æ–‡ä»¶çš„å¤§å°

#### Section

ç”¨æ¥å­˜å‚¨ç›®æ ‡æ–‡ä»¶ä¸­çš„ä¸€ä¸ªèŠ‚ï¼Œå…¶åŒ…å«çš„æˆå‘˜å˜é‡åŠå«ä¹‰å¦‚ä¸‹ï¼š

- name ï¼šèŠ‚åç§°
- type ï¼šèŠ‚ç±»å‹ï¼Œåœ¨æœ¬å®éªŒä¸­ç•¥
- flags ï¼šèŠ‚æ ‡å¿—ï¼Œåœ¨æœ¬å®éªŒä¸­ç•¥
- info ï¼šèŠ‚é™„åŠ ä¿¡æ¯ï¼Œåœ¨æœ¬å®éªŒä¸­ç•¥
- index ï¼šèŠ‚ä¸‹æ ‡
- addr ï¼šèŠ‚çš„èµ·å§‹åœ°å€
- off ï¼šèŠ‚åœ¨ç›®æ ‡æ–‡ä»¶ä¸­çš„åç§»é‡
- size ï¼šèŠ‚å¤§å°
- align ï¼šèŠ‚åœ¨ç›®æ ‡æ–‡ä»¶ä¸­çš„å¯¹é½é™åˆ¶

å…³äºtypeå’Œflagsçš„è¯¦ç»†ä¿¡æ¯å¯å‚è€ƒ[ELFæ–‡ä»¶çš„manæ‰‹å†Œä¸­æœ‰å…³Shdrçš„éƒ¨åˆ†](https://www.man7.org/linux/man-pages/man5/elf.5.html#:~:text=Section header (Shdr))ã€‚

#### Symbol

ç”¨æ¥å­˜å‚¨ç›®æ ‡æ–‡ä»¶ä¸­çš„ä¸€ä¸ªç¬¦å·ï¼Œå…¶åŒ…å«çš„æˆå‘˜å˜é‡åŠå«ä¹‰å¦‚ä¸‹ï¼š

- name ï¼šç¬¦å·åç§°ï¼Œä¸ºstringç±»å‹ã€‚
- value ï¼šç¬¦å·å€¼ï¼Œè¡¨ç¤ºç¬¦å·åœ¨å…¶æ‰€å±èŠ‚ä¸­çš„åç§»é‡ã€‚
- size ï¼šç¬¦å·å¤§å°ï¼Œå½“ç¬¦å·æœªå®šä¹‰æ—¶åˆ™ä¸º0
- type ï¼šç¬¦å·ç±»å‹ï¼Œä¾‹å¦‚ç¬¦å·æ˜¯å˜é‡è¿˜æ˜¯å‡½æ•°
- bind ï¼šç¬¦å·ç»‘å®šï¼Œä¾‹å¦‚ç¬¦å·ä¸ºå…¨å±€æˆ–å±€éƒ¨çš„
- visibility ï¼šç¬¦å·å¯è§æ€§ï¼Œæœ¬å®éªŒä¸­ç•¥
- offset ï¼šç¬¦å·åœ¨ç›®æ ‡æ–‡ä»¶ä¸­çš„åç§»é‡
- index ï¼šç¬¦å·ç›¸å…³èŠ‚çš„èŠ‚å¤´è¡¨ç´¢å¼•

#### RelocEntry

ç”¨æ¥å­˜å‚¨ç›®æ ‡æ–‡ä»¶ä¸­çš„ä¸€ä¸ªå¼•ç”¨äº§ç”Ÿçš„é‡å®šä½æ¡ç›®ï¼Œå…¶åŒ…å«çš„æˆå‘˜å˜é‡åŠå«ä¹‰å¦‚ä¸‹ï¼š

- sym ï¼šæŒ‡å‘ä¸è¯¥é‡å®šä½æ¡ç›®å…³è”çš„ç¬¦å·Symbolçš„æŒ‡é’ˆ
- name ï¼šé‡å®šä½æ¡ç›®å…³è”çš„ç¬¦å·åç§°ï¼Œç±»å‹ä¸ºstring
- offset ï¼šé‡å®šä½æ¡ç›®åœ¨èŠ‚ä¸­çš„åç§»é‡
- type ï¼šé‡å®šä½æ¡ç›®ç±»å‹
- addend ï¼šå¸¸é‡åŠ æ•°ï¼Œç”¨äºè®¡ç®—è¦å­˜å‚¨åˆ°å¯é‡å®šä½å­—æ®µä¸­çš„å€¼

#### allObject

ç”¨æ¥å­˜å‚¨æ‰€æœ‰ç›®æ ‡æ–‡ä»¶å¯¹åº”çš„`ObjectFile`æ•°æ®ç»“æ„ã€‚

#### mergedObject

æ‰€æœ‰ç›®æ ‡æ–‡ä»¶åˆå¹¶ä¸ºä¸€ä¸ªåå¯¹åº”çš„`ObjectFile`ã€‚

å¯¹äº **ç»å¯¹é‡å®šä½**ï¼ˆå¦‚ `R_X86_64_64`ï¼‰ï¼š

ç»“æœ=ç¬¦å·åœ°å€+addend\text{ç»“æœ} = \text{ç¬¦å·åœ°å€} + \text{addend}ç»“æœ=ç¬¦å·åœ°å€+addend

å¯¹äº **PC ç›¸å¯¹é‡å®šä½**ï¼ˆå¦‚ `R_X86_64_PC32`ï¼‰ï¼š

ç»“æœ=ç¬¦å·åœ°å€+addendâˆ’å½“å‰åœ°å€\text{ç»“æœ} = \text{ç¬¦å·åœ°å€} + \text{addend} - \text{å½“å‰åœ°å€}ç»“æœ=ç¬¦å·åœ°å€+addendâˆ’å½“å‰åœ°å€

> â€‹    æƒ³ä¸€æƒ³ï¼šä¸ºä»€ä¹ˆR_X86_64_32å¯¹åº”çš„addendä¸º0ï¼Œè€ŒR_X86_64_PC32ä¸æ˜¯ï¼Ÿaddendæœ‰ä»€ä¹ˆå®é™…æ„ä¹‰ï¼Ÿ

å‰é¢æ˜¯ç»å¯¹åœ°å€ï¼Œæˆ‘ä»¬æ˜¯ç›´æ¥å¾—åˆ°çš„ï¼Œä½†æ˜¯åé¢æ˜¯PCç›¸å¯¹å¯»å€ï¼Œä¹Ÿå°±æ˜¯è¯´callçš„æ—¶å€™ï¼Œæ˜¯ç›¸å¯¹äºæ­¤æ—¶çš„PCçš„å€¼çš„åç§»é‡è®¡ç®—çš„ï¼Œåœ¨æ‰¾æ•°ç»„ä¸­çš„æŸä¸ªå€¼çš„æ—¶å€™ä¹Ÿéå¸¸æœ‰ç”¨ã€‚

#### é‡å®šä½çš„é€»è¾‘ï¼š

> è¯´åˆ°é‡å®šä½å°±è¦è€ƒè™‘åˆ°é‡å®šä½è¡¨çš„é—®é¢˜ï¼Œæˆ‘ä»¬è¦å¦‚ä½•åˆ©ç”¨é‡å®šä½è¡¨ä¿®æ”¹å¯æ‰§è¡Œç›®æ ‡æ–‡ä»¶ä¸­çš„å ä½ç¬¦å·ï¼ˆ0000ï¼‰ã€‚

```C
#include "relocation.h"

#include <sys/mman.h>

// test0å’Œtest1éƒ½åªéœ€è¦è¿›è¡Œé‡å®šä½å³å¯
// é‡å®šä½æ˜¯åŠ è½½è¿™ä¸ªç¨‹åºä¹‹å‰æˆ‘è¦ä¿®æ”¹å€¼
void handleRela(std::vector<ObjectFile> &allObject, ObjectFile &mergedObject, bool isPIE)
{
    /* When there is more than 1 objects,
     * you need to adjust the offset of each RelocEntry
     */
    // åˆå¹¶ä¹‹åï¼Œæˆ‘ä»¬è¦æ›´æ”¹åç§»é‡,åœ¨å¤§äº1çš„æƒ…å†µä¸‹
    if (allObject.size() > 1)
    {
        // æ¯æ¬¡suméƒ½è¦åŠ ä¸Šä¸€æ•´ä¸ªèŠ‚å¤§å°çš„åç§»
        uint64_t sum = 0;
        for (auto &object : allObject)
        {
            for (auto &rel : object.relocTable)
            {
                rel.offset += sum;
            }
            sum += object.sections[".text"].size;
        }
    }

    /* in PIE executables, user code starts at 0xe9 by .text section */
    /* in non-PIE executables, user code starts at 0xe6 by .text section */
    // æ³¨æ„ textOff å’Œ textAddr çš„åŒºåˆ«ï¼štextOff æ˜¯æŒ‡ .text èŠ‚åœ¨ ELF æ–‡ä»¶ä¸­å­˜å‚¨çš„ä½ç½®ï¼Œè€Œ textAddr æ˜¯æŒ‡ .text èŠ‚è¢«è¿è¡Œæ—¶åŠ è½½ååœ¨å†…å­˜ä¸­æ‰€å¤„çš„ä½ç½®ã€‚
    // è¿™é‡Œéƒ½æ˜¯mergeObjectçš„ä½ç½®
    uint64_t userCodeStart = isPIE ? 0xe9 : 0xe6;
    uint64_t textOff = mergedObject.sections[".text"].off + userCodeStart;
    uint64_t textAddr = mergedObject.sections[".text"].addr + userCodeStart;

    for (auto &object : allObject)
    {
        for (auto &rel : object.relocTable)
        {

            // ç›´æ¥è½¬æ¢
            uint64_t baseAddr = reinterpret_cast<uint64_t>(mergedObject.baseAddr);

            // æŸ¥çœ‹é‡å®šä½çš„ç±»å‹
            // ç›¸å¯¹å¯»å€
            if (rel.type == R_X86_64_PLT32 || rel.type == R_X86_64_PC32)
            {
                // å¡«å…¥ç›®æ ‡æŒ‡ä»¤åœ°å€å’Œå½“å‰PCçš„å·®å€¼ + è¡¥å¿é‡
                int val = rel.sym->value - (textAddr + rel.offset) + rel.addend;
                // æ³¨æ„è¿™é‡Œçš„åœ°å€æ˜¯32ä½çš„åœ°å€
                *reinterpret_cast<int *>(baseAddr + textOff + rel.offset) = val;
            }
            // è¿™æ˜¯ç»å¯¹åœ°å€
            else if (rel.type == R_X86_64_32)
            {
                int val = rel.sym->value + rel.addend;
                *reinterpret_cast<int *>(baseAddr + textOff + rel.offset) = val;
            }
            else
            {
                fprintf(stderr, "There is something wrong...\n");
            }
        }
    }
}
```

#### ç¬¦å·è§£æçš„é€»è¾‘ï¼š

è¿™å’Œä¹‹å‰æˆ‘ä»¬è®¨è®ºåº“æ˜¯æ€ä¹ˆåŠ è½½çš„æ˜¯ç±»ä¼¼çš„ï¼Œæˆ‘ä»¬ç»´æŠ¤é›†åˆã€‚

> çœ‹äº†åˆ«äººçš„ä»£ç ï¼Œä¸ºäº†é˜²æ­¢æœ‰æŠ„è¢­çš„é£é™©ï¼Œæˆ‘å°±æœ‰éƒ¨åˆ†å†™çš„æ¯”è¾ƒæŠ½è±¡ã€‚

```C
#include "resolve.h"

#include <iostream>

#define FOUND_ALL_DEF 0
#define MULTI_DEF 1
#define NO_DEF 2

std::string errSymName;

int callResolveSymbols(std::vector<ObjectFile> &allObjects);

void resolveSymbols(std::vector<ObjectFile> &allObjects)
{
    int ret = callResolveSymbols(allObjects);
    if (ret == MULTI_DEF)
    {
        std::cerr << "multiple definition for symbol " << errSymName << std::endl;
        abort();
    }
    else if (ret == NO_DEF)
    {
        std::cerr << "undefined reference for symbol " << errSymName << std::endl;
        abort();
    }
}

/* bind each undefined reference (reloc entry) to the exact valid symbol table entry
 * Throw correct errors when a reference is not bound to definition,
 * or there is more than one definition.
 */

// è¿™é‡Œæˆ‘ä»¬è¦åšä¸‰ä»¶äº‹æƒ…1.æ‰¾æœªå®šä¹‰çš„ç¬¦å·2.å¤šé‡å®šä¹‰3.æŠŠå¼±ç¬¦å·ç»‘å®šåˆ°å¼ºç¬¦å·ä¸Šé¢å»
int callResolveSymbols(std::vector<ObjectFile> &allObjects)
{

    // if found multiple definition, set the errSymName to problematic symbol name and return MULTIDEF;
    // if no definition is found, set the errSymName to problematic symbol name and return NODEF;
    // ç»´æŠ¤ä¸¤ä¸ªé›†åˆï¼Œstrongå’Œweak
    // å‰é¢æ˜¯nameï¼Œåé¢æ˜¯å¯¹åº”çš„*symbol
    std::unordered_map<std::string, Symbol *> weakMap;
    std::unordered_map<std::string, Symbol *> strongMap;

    for (auto &object : allObjects)
    {
        // éå†ç¬¦å·è¡¨
        for (auto &symbol : object.symbolTable)
        {
            // æ‰¾åˆ°äº†ä¸€ä¸ªå¼ºç¬¦å·
            if (symbol.index != SHN_UNDEF && symbol.index != SHN_COMMON && symbol.bind == STB_GLOBAL)
            {
                // å·²ç»å­˜åœ¨ï¼Œè¡¨æ˜å¤šé‡å®šä¹‰
                if (strongMap.find(symbol.name) != strongMap.end())
                {
                    errSymName = symbol.name;
                    return MULTI_DEF;
                }
                else
                {
                    // åŸæ¥æ²¡æœ‰ï¼Œç›´æ¥ç»‘å®š
                    strongMap.emplace(symbol.name, &symbol);
                }
            }
        }
    }

    // æŠŠæ‰€æœ‰å¼ºç¬¦å·ç»‘å®šå¥½äº†ä¹‹åï¼Œå†å»å¤„ç†å¼±ç¬¦å·
    for (auto &object : allObjects)
    {
        for (auto &symbol : object.symbolTable)
        {
            if (symbol.index == SHN_COMMON && symbol.bind == STB_GLOBAL)
            {
                // ä¸å­˜åœ¨ç›´æ¥ç»‘å®š
                if (weakMap.find(symbol.name) == weakMap.end())
                {
                    weakMap.emplace(symbol.name, &symbol);
                }
            }
        }
    }

    // å¤„ç†å¼±ç¬¦å·å’Œå¼ºç¬¦å·ç›¸åŒçš„æƒ…å†µ
    for (auto it = weakMap.begin(); it != weakMap.end(); ++it)
    {
        if (strongMap.find(it->first) != strongMap.end())
        {
            it->second->value = strongMap[it->first]->value;
            it->second->index = strongMap[it->first]->index;
        }
    }

    // éå†é‡å®šä½ç¬¦å·è¡¨ï¼Œå“ªäº›ç¬¦å·è¦é‡å®šä½ä½†æ˜¯æ²¡æœ‰åœ¨mapé‡Œï¼Œè¯´æ˜æœªå®šä¹‰çš„é”™è¯¯
    // é‡å®šä½çš„symbolåœ¨æœ€åæ£€æŸ¥çš„æ—¶å€™è¢«ç»‘å®š
    for (auto &object : allObjects)
    {
        for (auto &rel : object.relocTable)
        {
            if (strongMap.find(rel.name) != strongMap.end())
            {
                rel.sym = strongMap[rel.name];
            }
            else if (weakMap.find(rel.name) != weakMap.end())
            {
                rel.sym = weakMap[rel.name];
            }
            else
            {
                errSymName = rel.name;
                return NO_DEF;
            }
        }
    }
    return FOUND_ALL_DEF;
}

```

> æ€»ä¹‹ï¼Œé“¾æ¥æ˜¯ä¸€ä¸ªå¤æ‚çš„è¯é¢˜ï¼Œç‰µæ‰¯çš„çŸ¥è¯†å¾ˆå¤šä¸”æ‚ï¼Œè¿˜æœ‰åŠ¨æ€DLLï¼Œåº“æ‰“æ¡©æœºåˆ¶ç­‰å†…å®¹ï¼Œä¹‹åå†åšäº†è§£ã€‚







