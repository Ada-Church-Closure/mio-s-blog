+++
date = '2025-03-10T12:35:52+08:00'
draft = false
title = 'ComputerOrgnization'
+++

> æœ¬æœŸå°é¢æ˜¯åŠ¨æ¼«ã€Šç™½ç®±ã€‹çš„ä¸»è§’å›¢ï¼Œå¦‚æœä½ å¯¹äºåŠ¨æ¼«åˆ¶ä½œçš„å¹•åæ„Ÿå…´è¶£ï¼Œè¿™æ˜¯ä¸€éƒ¨ä¸å¯å¤šå¾—çš„ä½³ä½œã€‚

# **Computer Organization**

> [!NOTE]
>
> åœ¨æœ¬ç¯‡ä¹‹å‰ï¼Œæˆ‘å·²ç»å®ç°äº†ä¸€ä¸ªéå¸¸ç®€å•çš„CPUï¼ˆæ„Ÿè§‰éƒ½æ˜¯å±äºæ•°å­—ç”µè·¯çš„å†…å®¹ï¼Œå½“ç„¶ä¹Ÿæ˜¯è®¡ç»„çš„ä¸€éƒ¨åˆ†ï¼‰ï¼Œè¯¾ç¨‹ç¬”è®°ä»¥åŠèµ„æºéƒ½æ¥è‡ªäºBç«™ï¼šCs Primerã€‚
>
> æ‰€ä»¥åœ¨è¿™é‡Œåªæ˜¯ç®€å•è®°å½•ä¸€äº›æ„Ÿè§‰æœ‰å¿…è¦çš„ç†è®ºçŸ¥è¯†ï¼Œè¿˜ä¼šä¸æ–­è¡¥å……ã€‚

## Cacheï¼ˆå­˜å‚¨å™¨å±‚æ¬¡ç»“æ„ï¼‰

1.DRAM SRAM SSD æœºæ¢°ç¡¬ç›˜è¯»å†™ä»¥åŠå­˜å‚¨ï¼Œå–å†…å­˜å’Œå®é™…CPUä¹‹é—´çš„å·®å¼‚æ€§ã€‚

2.ç¨‹åºçš„å±€éƒ¨æ€§ï¼ˆLocalityï¼‰:ç¨‹åºå€¾å‘äºå¼•ç”¨é‚»è¿‘äºæœ€è¿‘å¼•ç”¨è¿‡çš„æ•°æ®é¡¹æˆ–è€…æ˜¯å·²ç»å¼•ç”¨è¿‡çš„æ•°æ®é¡¹æœ¬èº«ï¼ˆforéå†æ•°ç»„ï¼‰

a.ç©ºé—´å±€éƒ¨æ€§ b.æ—¶é—´å±€éƒ¨æ€§

å¼•å…¥ï¼š

![image-20250304202823299](/img/image-20250304202823299.png)

### é«˜é€Ÿç¼“å­˜å­˜å‚¨å™¨

#### 1.ç»“æ„

![image-20250306193154854](/img/image-20250306193154854.png)

**SBE**ä¸ºæ€»çš„å¤§å°ã€‚

å¯»å€åŸç†ï¼šhash

![image-20250306193715440](/img/image-20250306193715440.png)

#### 2.ç›´æ¥æ˜ å°„é«˜é€Ÿç¼“å­˜ï¼ˆdirect-mapped cacheï¼‰

å°±æ˜¯æ¯ç»„åªæœ‰ä¸€ä¸ªè¡Œ

![image-20250306194358596](/img/image-20250306194358596.png)

è¿‡ç¨‹

a.ç»„é€‰æ‹©

**ä¸ºä»€ä¹ˆæŠŠä¸­é—´çš„ä½ä½œä¸ºç»„ç´¢å¼•è€Œä¸æ˜¯æ›´é«˜çš„ä½ï¼Ÿ**

å¦‚æœé«˜ä½åšç´¢å¼•ï¼Œé‚£ä¹ˆå¾ˆå®¹æ˜“æŠŠä¸€å †è¿ç»­çš„å—æ˜ å°„åˆ°ä¸€ç»„é«˜é€Ÿç¼“å­˜å—é‡Œé¢ï¼Œè¿™æ ·ä¸ç¬¦åˆç©ºé—´å±€éƒ¨æ€§ã€‚

ä¸­é—´çš„éšæœºæ€§ç›¸å¯¹æ›´å¤§ä¸€äº›ã€‚

![image-20250306194739351](/img/image-20250306194739351.png)

b.æ‰¾åˆ°äº†ç»„ï¼Œè¿›è¡Œè¡ŒåŒ¹é…

![image-20250306194957319](/img/image-20250306194957319.png)

c.æ ¹æ®å—åç§»ä½æ¥å¯»æ‰¾ç¬¬ä¸€ä¸ªå­—èŠ‚çš„ä½ç½®

d.å¦‚æœæ²¡æœ‰å‘½ä¸­ï¼Œä»ä¸‹ä¸€çº§å†…å­˜ä¸­å–ç›¸åº”çš„å†…å­˜å—å¹¶ä¸”ç›´æ¥åšæ›¿æ¢çš„æ“ä½œ

e.å®é™…è¿‡ç¨‹ï¼šå¼€å§‹ç¼“å­˜ä¸ºç©ºï¼Œå†·ä¸å‘½ä¸­ï¼Œä»L2ä¸­åŠ è½½æ•°æ®åˆ°L1,ç„¶åè¿”å›ï¼Œæ¥ç€å‡å¦‚æ ‡å¿—ä½ä¸ç›¸åŒï¼Œå‘ç”Ÿå†²çªä¸å‘½ä¸­ï¼Œè¿›è¡Œæ›¿æ¢æ“ä½œã€‚

d.å†²çªä¸å‘½ä¸­å¸¸è§ï¼šthrash,é«˜é€Ÿç¼“å­˜åå¤çš„åŠ è½½å’Œé©±é€ç›¸åŒçš„ä¸€äº›ç»„ã€‚

#### 3.ç»„ç›¸è”é«˜é€Ÿç¼“å­˜(set associative cache)

å°±æ˜¯æ¯ä¸ªç»„åŒ…å«å¤šäºä¸€ä¸ªçš„è¡Œ

![image-20250306203058530](/img/image-20250306203058530.png)

å’Œæ¯ä¸ªè¡Œè¿›è¡Œä¸€æ¬¡åŒ¹é…

**LFUå’ŒLRUç­–ç•¥**

#### 4.å…¨ç›¸è”é«˜é€Ÿç¼“å­˜ï¼ˆfully asscociative cacheï¼‰

å°±æ˜¯åªæœ‰ä¸€ä¸ªç»„ï¼Œé‡Œé¢æœ‰å¾ˆå¤šè¡Œ

![image-20250306203614011](/img/image-20250306203614011.png)

æ²¡æœ‰ç»„çš„é€‰æ‹©ï¼Œåªæœ‰æ ‡è®°ä½å’Œå—åç§»ã€‚







## å•å‘¨æœŸå¤šå‘¨æœŸå¤„ç†å™¨

ä¸€ä¸ªæ—¶é’Ÿå‘¨æœŸå†…å®Œæˆä¸€æ¡æŒ‡ä»¤

å¤šå‘¨æœŸå°±æ˜¯ä¸€æ¡æŒ‡ä»¤å¤šä¸ªæ—¶é’Ÿå‘¨æœŸ

## æµæ°´çº¿æŠ€æœ¯

![image-20250220143616648](/img/image-20250220143616648.png)

### äº”é˜¶æ®µæµæ°´çº¿

æŠŠæ¯ä¸ªæŒ‡ä»¤éƒ½å¡«å……æˆäº”ä¸ªé˜¶æ®µï¼Œé˜²æ­¢å†²çª

### æµæ°´çº¿å†’é™©

#### ç»“æ„å†’é™©ï¼šç¡¬ä»¶èµ„æºäº§ç”Ÿå†²çª

#### æ•°æ®å†’é™©ï¼šé€»è¾‘ä¸Šçš„æ•°æ®ä¾èµ–æ€§äº§ç”Ÿå†²çª

#### æ§åˆ¶å†’é™©ï¼šè·³è½¬åˆ°åˆ«çš„æŒ‡ä»¤ï¼Œå¯¼è‡´æµæ°´çº¿ä¹‹å‰å‡†å¤‡çš„æŒ‡ä»¤æ— æ•ˆ

è§£å†³ï¼šåˆ†æ”¯é¢„æµ‹ï¼ˆåŠ¨æ€ï¼‰

------

# åœ¨X86ç³»ç»Ÿä¸Šç¼–å†™å’Œè¿è¡Œç¨‹åº

## ä¸€ä¸ªCç¨‹åºå¤„ç†æµç¨‹

![image-20250222132826407](/img/image-20250222132826407.png)

é¢„å¤„ç†-ç¼–è¯‘-æ±‡ç¼–-é“¾æ¥-ç¨‹åºåŠ è½½æ‰§è¡Œ

å‡è®¾æˆ‘ä»¬æœ‰æ–‡ä»¶**main.c** **hello.c**

```c
gcc main.c hello.c	//è¿™ä¸€æ¡æŒ‡ä»¤åŒ…å«äº†ä¸Šè¿°çš„å››ä¸ªæ­¥éª¤
```

```C
gcc -E hello.c -o hello.i //è¿™è¡¨ç¤ºå¯¹äºæ–‡ä»¶è¿›è¡Œé¢„å¤„ç† -oæ˜¯æŒ‡å®šåç§°ï¼ˆæ“¦é™¤å¹¶ä¸”è¿›è¡Œå¤åˆ¶ç²˜è´´çš„æµç¨‹ï¼‰
```

```c
gcc -S hello.i -o hello.s	//æŠŠé¢„å¤„ç†ä¹‹åçš„æ–‡ä»¶å¤„ç†æˆæ±‡ç¼–ä»£ç 
```

```C
gcc -c hello.s -o hello.o	//æ±‡ç¼–æˆä¸€ä¸ªäºŒè¿›åˆ¶æ–‡ä»¶ï¼Œä½†æ˜¯ä¸è¿›è¡Œé“¾æ¥çš„æ“ä½œ
```

å·¥å…·ï¼š**readelf**ï¼ˆæŸ¥çœ‹æ®µçš„åç§»ï¼‰ **objdump**ï¼ˆåæ±‡ç¼–ï¼‰ **hexdump**ï¼ˆæŸ¥çœ‹äºŒè¿›åˆ¶æ–‡ä»¶çš„æœºå™¨ç ï¼‰

```C
gcc main.o hello.o	//ç›´æ¥å°†ä¸¤ä¸ªæ–‡ä»¶è¿›è¡Œé“¾æ¥ï¼Œå¦‚ä¸‹æ˜¯é“¾æ¥çš„è¿‡ç¨‹
```

![image-20250222135247623](/img/image-20250222135247623.png)

æ¥ç€æ˜¯ç¨‹åºåŠ è½½æ‰§è¡Œçš„æµç¨‹

![image-20250222140136354](/img/image-20250222140136354.png)

## å¸¸è§X86æ±‡ç¼–æŒ‡ä»¤

å¯ä»¥å‚ç…§CSAPPç†Ÿæ‚‰åŸºæœ¬è¯­æ³•ï¼Œè¾¾åˆ°èƒ½è¯»çš„è¦æ±‚å³å¯

> [!TIP]
>
> jmpç±»æ¡ä»¶è·³è½¬æŒ‡ä»¤ä¹‹å‰å¯ä»¥è·Ÿå…¶ä»–è®¸å¤šæŒ‡ä»¤
>
> æ¯”å¦‚ subl  a,b ä¹Ÿå¯ä»¥çœ‹aå’Œbä¹‹é—´æ»¡è¶³çš„æ¡ä»¶

### 64ä½ä½¿ç”¨çš„å¯„å­˜å™¨

![image-20250223163504717](/img/image-20250223163504717.png)

### æ•°æ®ä¼ é€æŒ‡ä»¤

#### moveï¼šä¸èƒ½ä»å†…å­˜ç›´æ¥åˆ°å†…å­˜ä¼ é€

> [!NOTE]
>
> æˆ‘çœ‹è¿‡å¥½å‡ éä¹¦ï¼Œä½†æ˜¯æˆ‘æ„Ÿè§‰è‡ªå·±æœ€éš¾ç†è§£çš„åœ°æ–¹å°±æ˜¯å‡½æ•°çš„è°ƒç”¨ä»¥åŠé€’å½’è¿™é‡Œçš„ä¸œè¥¿ï¼Œå»ºè®®å¤§å®¶ä»pushè¿™é‡Œå¼€å§‹ç»†ç»†ç†è§£ã€‚

#### **push**æŒ‡ä»¤ï¼š

1.æŠŠæ ˆæŒ‡é’ˆå‡å»8,å¾—åˆ°æ ˆé¡¶ä½ç½®ï¼Œæ­¤æ—¶æ ˆé¡¶è¿˜æ²¡æœ‰å…ƒç´ ã€‚2.æŠŠç›®çš„æ“ä½œæ•°æ”¾åˆ°æ ˆé¡¶ã€‚ï¼ˆpushåªè¦ä¸€ä¸ªbyteï¼Œæ ˆä¸Šåªæ˜¯æ”¾äº†ä¸€å †dataï¼Œå’Œå¯„å­˜å™¨ï¼Œå’Œå†…å­˜éƒ½æ²¡æœ‰å…³ç³»ï¼‰

é‚£ä¹ˆpopæŒ‡ä»¤åŒç†ï¼š1.æŠŠæ ˆé¡¶çš„å€¼è¯»å…¥ä¸€ä¸ªç›®æ ‡å¯„å­˜å™¨ã€‚2.æŠŠæ ˆæŒ‡é’ˆåŠ 8ã€‚

### æ¡ä»¶æ§åˆ¶

if for whileç­‰è¯­å¥éƒ½æ˜¯æ¡ä»¶è·³è½¬æ¥å®ç°çš„

switchè¯­å¥å½“caseèŒƒå›´è¾ƒå¤§æ—¶ä¹Ÿæ˜¯æ¡ä»¶è·³è½¬ï¼Œå½“èŒƒå›´è¾ƒå°æ˜¯åˆ©ç”¨è·³è½¬è¡¨ï¼Œä¸€ä¸ªè¿ç»­æ•°ç»„çš„å€¼åŸŸåŒ…å«äº†æ‰€æœ‰çš„caseæƒ…å†µ(å¹¶ä¸”caseçš„æ•°é‡è¾ƒå¤š)

### *Processï¼ˆè¿‡ç¨‹ï¼‰

æ§åˆ¶ + ä¼ é€’ + å†…å­˜ç®¡ç†

#### è¿è¡Œæ—¶æ ˆï¼ˆæå‰å‡†å¤‡ï¼‰

![image-20250223172641504](/img/image-20250223172641504.png)

På»è°ƒç”¨Qï¼Œé¦–å…ˆå­˜æ”¾è¿”å›åœ°å€ï¼Œè¡¨æ˜Qè¿”å›æ—¶ä»Pçš„å“ªä¸ªä½ç½®å¼€å§‹æ‰§è¡Œï¼Œè¿™ä¸ªåœ°å€ä¹Ÿæ˜¯Pæ ˆå¸§çš„ä¸€éƒ¨åˆ†ã€‚

æ¥ç€ä¸ºQåˆ†é…ä¸€ä¸ªæ ˆå¸§ï¼Œå¤§å¤šæ•°çš„æ ˆå¸§éƒ½æ˜¯å®šé•¿çš„ï¼Œé€šè¿‡å¯„å­˜å™¨ä¼ é€’å‚æ•°ï¼Œå¦‚æœå¤§äº6ä¸ªï¼ŒPåœ¨è°ƒç”¨Qä¹‹å‰æå‰åœ¨è‡ªå·±çš„æ ˆå¸§é‡Œå­˜å‚¨å¥½è¿™äº›å‚æ•°ã€‚

#### è½¬ç§»æ§åˆ¶ï¼ˆæ€ä¹ˆäº¤æ¥æ§åˆ¶æƒåˆ©ï¼‰

**call:æŠŠripçš„å€¼è®¾ç½®æˆcalleeçš„é¦–åœ°å€ï¼Œè¿™æ ·å°±æŠŠæ‰§è¡Œæƒåˆ©è½¬æ¢ï¼Œæ¥ç€æŠŠcallæŒ‡ä»¤ä¸‹ä¸€æ¡æŒ‡ä»¤çš„åœ°å€å‹å…¥æ ˆä¸­ã€‚**

**retï¼šæŠŠå‹å…¥æ ˆçš„åœ°å€å¼¹å‡ºæ¥ï¼Œå¹¶ä¸”æŠŠripçš„å€¼è®¾ç½®æˆè¿™ä¸ªåœ°å€ï¼Œè¿™æ ·å°±äº¤è¿˜äº†æ§åˆ¶æƒåˆ©ã€‚**

#### æ•°æ®ä¼ é€ï¼ˆæ€ä¹ˆç»™Calleeä¼ é€’ä¸€äº›å‚æ•°ï¼‰

åœ¨å‚æ•°å°äº6ä¸ªçš„æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬ç›´æ¥ç”¨å¯„å­˜å™¨æ¥ä¼ é€’ï¼Œç”¨raxæ¥è·å¾—è°ƒç”¨æ–¹æ³•çš„è¿”å›å€¼å³å¯ã€‚

åœ¨ä¸Šå›¾çš„**Current** **frame**ä¸­æœ‰ä¸€ä¸ª**Argument** **build** **area**ï¼Œè¿™å°±æ˜¯ä¸€ä¸ªå‚æ•°æ„é€ åŒºï¼Œå¦‚æœå®ƒä¹Ÿè¦è°ƒç”¨ä¸€ä¸ªå‚æ•°å¤šäº6ä¸ªçš„æ–¹æ³•ï¼Œé‚£ä¹ˆå°±è¦æå‰åœ¨è‡ªå·±çš„æ ˆå¸§é‡Œå‡†å¤‡å¥½ï¼Œå†æ‰§è¡ŒcallæŒ‡ä»¤ï¼ˆæ³¨æ„ï¼šç¬¬ä¸ƒä¸ªå‚æ•°ä¼šåœ¨æ ˆçš„é¡¶éƒ¨ï¼‰ã€‚

#### æ ˆä¸Šçš„å±€éƒ¨å­˜å‚¨ï¼ˆCalleeä¸­çš„å±€éƒ¨å˜é‡æ˜¯æ€ä¹ˆå®ç°çš„ï¼‰

æ¯”å¦‚å±€éƒ¨å˜é‡å¤ªå¤šï¼Œè¦å–å±€éƒ¨å˜é‡çš„ä¸€ä¸ªåœ°å€ï¼Œæˆ–è€…å±€éƒ¨å˜é‡æ˜¯æ•°ç»„åŠç»“æ„ä½“ç­‰ã€‚

è¿˜æ˜¯ä¸Šå›¾ï¼Œå‚æ•°æ„é€ åŒºä¹‹ä¸Šå°±æ˜¯æˆ‘ä»¬å‡å°‘æ ˆæŒ‡é’ˆåˆ†é…ç»™å±€éƒ¨å˜é‡çš„ç©ºé—´ã€‚

ä¸‹ä¾‹å‡ºè‡ªCSAPP

```c
long swap_add (long *XP , long * yp)
{
long x = *xp ;
long y = * yp ;
*xp = y ;
*yp = x ;
return x + y ;
}

long caller ()
{
//è¦å¤„ç†ä»¥ä¸‹ä¸¤ä¸ªå±€éƒ¨å˜é‡ï¼Œæˆ‘å°±è¦ä¸ºä»–ä»¬äº§ç”Ÿåœ°å€ã€‚
long argl = 534 ;
long arg2 = 1057 ;
long sum = swap_add (&argl , &arg2) ;
long diff = argl - arg2 ;
return sum * diff;
}
```

ä»¥ä¸‹æ˜¯æ±‡ç¼–ä»£ç 

```assembly
long caller()
caller:
subq $16 , %rsp
movq $534 , (%rsp)
movq $1057 , 8(%rsp)
leaq 8(%rsp) , %rsi
movq %rsp , %rdi
call swap_add	;è¿™é‡Œçš„ç»†èŠ‚ï¼šæ–¹æ³•è™½ç„¶å·²ç»è¿”å›ï¼ˆè¿”å›ä¹‹åä¹‹å‰å‹å…¥çš„è¿”å›åœ°å€å°±ä¼šè¢«å¼¹å‡ºï¼‰ï¼Œä½†æ˜¯æ ˆå¸§è¿˜åœ¨ï¼Œæ‰€ä»¥åˆ†é…çš„å±€éƒ¨å˜é‡è¿˜åœ¨
movq (%rsp) , %rdx
subq 8(%rsp) ,%rdx 
imulq %rdx , %rax
addq $16 , %rsp	;æ­¤æ—¶æ ˆå¸§ä¸å­˜åœ¨ï¼Œä¼šè¢«åæ¥çš„dataè¦†ç›–æ‰
ret
```

æ ˆå¸§åˆ†é…åˆ°åº•æ‹¿æ¥å¹²å˜›äº†ï¼Ÿ

çœ‹ä¸‹å›¾ï¼š

åˆ†é…æ ˆå¸§ï¼Œå…ˆç”¨æ¥å­˜æ”¾æœ¬æ–¹æ³•è¦ç”¨çš„å±€éƒ¨å˜é‡ï¼Œæ¥ç€æ˜¯å¤šäº6ä¸ªçš„å‚æ•°ä»å³è‡³å·¦ä¾æ¬¡å‹å…¥æ ˆä¸­ï¼Œç„¶å**call**ï¼Œæ³¨æ„ï¼Œä¸è¦æ··æ·†å±€éƒ¨å˜é‡å’Œä¼ é€’çš„å‚æ•°ï¼Œåœ¨è¢«è°ƒç”¨çš„æ–¹æ³•ä¸­æ˜¯ä¸ä¼šç”¨å‰ä¸€ä¸ªæ–¹æ³•æ ˆå¸§ä¸­çš„å±€éƒ¨å˜é‡çš„ã€‚

![image-20250223221347529](/img/image-20250223221347529.png)

#### å¯„å­˜å™¨ä¸­çš„å±€éƒ¨å­˜å‚¨ç©ºé—´

##### **ğŸ”¹ è¿™äº›å¯„å­˜å™¨ä¸»è¦ç”¨äºä»€ä¹ˆï¼Ÿ**

###### **1. å­˜å‚¨å±€éƒ¨å˜é‡**

ï¼ˆè¿™ä¹Ÿæ˜¯ä¸€ç§å­˜å‚¨å±€éƒ¨å˜é‡çš„æ–¹æ³•ï¼Œæ¯”å¦‚åœ¨forå¾ªç¯ä¸­çš„indexï¼‰

å¦‚æœä¸€ä¸ªå‡½æ•°æœ‰**å±€éƒ¨å˜é‡**ï¼Œä½†å¯„å­˜å™¨åˆ†é…ä¸è¶³ï¼Œç¼–è¯‘å™¨å¯èƒ½ä¼šæŠŠä¸€äº›å˜é‡**ä¿å­˜åœ¨è¢«è°ƒç”¨è€…ä¿å­˜å¯„å­˜å™¨é‡Œ**ï¼Œé¿å…é¢‘ç¹è®¿é—®æ ˆï¼ˆæ¯”æ ˆä¸Šçš„å˜é‡è®¿é—®å¿«ï¼‰ã€‚

###### **2. ç»´æŒé•¿æœŸå˜é‡ï¼ˆLong-lived variablesï¼‰**

å¦‚æœæŸä¸ªå˜é‡åœ¨æ•´ä¸ªå‡½æ•°ç”Ÿå‘½å‘¨æœŸå†…éƒ½ä¼šè¢«ä½¿ç”¨ï¼Œè€Œéä¸´æ—¶æ•°æ®ï¼Œå°±å¯èƒ½æ”¾åœ¨ **`%rbx`ã€`%r12-%r15`** è¿™äº›å¯„å­˜å™¨é‡Œã€‚

###### **3. ç»´æŠ¤æ ˆå¸§æŒ‡é’ˆï¼ˆ`%rbp`ï¼‰**

è™½ç„¶ç°ä»£ç¼–è¯‘å™¨å¯èƒ½ä¼šçœç•¥æ ˆå¸§æŒ‡é’ˆï¼ˆFrame Pointer Omission, FPOï¼‰ï¼Œä½†åœ¨è°ƒè¯•æ¨¡å¼ä¸‹ï¼Œ`%rbp` ä»ç„¶ç”¨äº**ä¿æŒå½“å‰å‡½æ•°çš„æ ˆåŸºå€**ï¼Œå¸®åŠ©å›æº¯è°ƒç”¨æ ˆã€‚

###### **4. ä¼ é€’è·¨å‡½æ•°è°ƒç”¨çš„å€¼**

åœ¨ä¸€äº›æƒ…å†µä¸‹ï¼Œå¦‚æœä¸€ä¸ªå€¼éœ€è¦**åœ¨å¤šä¸ªå‡½æ•°è°ƒç”¨ä¹‹é—´ä¿æŒä¸å˜**ï¼Œå°±å¯èƒ½å­˜å…¥è¢«è°ƒç”¨è€…ä¿å­˜å¯„å­˜å™¨ï¼Œæ¯”å¦‚ï¼š

- é€’å½’å‡½æ•°ä¸­ï¼ŒæŸäº›å‚æ•°å¯èƒ½éœ€è¦è·¨å¤šæ¬¡é€’å½’è°ƒç”¨ä¿æŒä¸å˜ã€‚
- åœ¨åç¨‹æˆ–ä¸Šä¸‹æ–‡åˆ‡æ¢çš„ä»£ç é‡Œï¼ŒæŸäº›å¯„å­˜å™¨å¯èƒ½å­˜å‚¨ç‰¹å®šçš„ä»»åŠ¡çŠ¶æ€ã€‚

#### é€’å½’è¿‡ç¨‹

åˆ°è¿™é‡Œï¼Œç†è§£é€’å½’è¿‡ç¨‹å°±æ˜¯ç®€å•çš„äº†ï¼Œè°ƒç”¨è‡ªå·±å’Œè°ƒç”¨ä»»ä½•ä¸€ä¸ªè¿‡ç¨‹éƒ½æ˜¯ç±»ä¼¼çš„ï¼Œæ¯ä¸ªå‡½æ•°éƒ½æœ‰è‡ªå·±çš„ç§æœ‰çš„æ ˆå¸§ã€‚

æˆ‘ä»¬éš¾ç†è§£çš„æƒ…å†µæ˜¯æ ˆå¸§é‡Œä¸œè¥¿å¤ªå¤æ‚çš„æƒ…å†µã€‚

### æ•°ç»„çš„åˆ†é…å’Œè®¿é—®

1.æŒ‡é’ˆè®¿é—®ï¼Œå¦‚æœæ˜¯åœ°å€ï¼Œå°±ç”¨leaqåŠ è½½æœ‰æ•ˆåœ°å€ï¼Œå¦‚æœæ˜¯å–å€¼å°±ç”¨movæŒ‡ä»¤å³å¯ã€‚

2.å¤šç»´æ•°ç»„

3.å®šé•¿å˜é•¿æ•°ç»„ä»¥åŠç»“æ„ä½“

### å…³äºç¼“å†²åŒºæº¢å‡ºé—®é¢˜

## Cè¯­è¨€åŸºç¡€

å…³äºä½è¿ç®—çš„æŠ€å·§

å®å®šä¹‰å‡½æ•°å¤šè¡Œç”¨\åˆ†å¼€ï¼Œç”¨do {......} while(0)åƒæ‰;ï¼ˆç»†èŠ‚é—®é¢˜ï¼‰

å†…è”å‡½æ•°ï¼šç±»ä¼¼å®å®šä¹‰ï¼Œè°ƒç”¨çš„å‡½æ•°ä¸è·³è½¬ï¼Œç›´æ¥å±•å¼€ï¼ŒèŠ‚çº¦èµ„æºï¼ˆæ ¹æ®ç¼–è¯‘å™¨çš„æƒ…å†µè€Œå®š) 

```c
static inline int(...){......}	//ä¸€èˆ¬è¿™æ ·å®šä¹‰åœ¨å¤´æ–‡ä»¶é‡Œä½¿ç”¨
```

å…³äºCè¯­è¨€ä¸å†èµ˜è¿°

## æµ®ç‚¹æ•°è¯¦è§£

### æµ®ç‚¹æ•°å­˜å‚¨å½¢å¼

ï¼ˆå°æ•°ç‚¹æµ®åŠ¨ï¼‰è¿›åˆ¶è½¬æ¢ï¼ˆæ•°å­—ç”µè·¯å†…å®¹ï¼‰

> [!NOTE]
>
> IEEE754å…¸ä¸­å…¸

![image-20250222142456570](/img/image-20250222142456570.png)

è¿™é‡Œçš„**å°¾æ•°**å…¶å®æŒ‡çš„å°±æ˜¯å°æ•°ç‚¹ä¹‹åçš„äºŒè¿›åˆ¶è¡¨ç¤ºï¼š

æ¯”å¦‚2.5 = 10.1b

å³
$$
2.5 = 1.01*2^1
$$

> [!NOTE]
>
> è¿™æ˜¯ä¸€ä¸ªè§„æ ¼åŒ–çš„æµ®ç‚¹æ•°ï¼Œæ‰€è°“è§„æ ¼åŒ–ï¼Œæˆ‘ä»¬é»˜è®¤ä¸€ä¸ªæµ®ç‚¹æ•°æ˜¯å¤§äº1çš„ï¼Œå³æœ‰ä¸€ä¸ªéšå«çš„å‰å¯¼1,æˆ‘ä»¬åªåœ¨å°¾æ•°çš„23ä½ä¸­å­˜å‚¨å°æ•°ç‚¹çš„éƒ¨åˆ†å³å¯ï¼Œä½†æ˜¯å¦‚æœæŒ‡æ•°éƒ¨åˆ†ä¸º0,ä½†æ˜¯å°¾æ•°ä¸ä¸º0,è¿™å°±æ˜¯ä¸€ä¸ªéè§„æ ¼åŒ–çš„æµ®ç‚¹æ•°ï¼Œè®¡ç®—çš„è§„åˆ™å·²ç»å‘ç”Ÿäº†æ”¹å˜ï¼Œæ­¤æ—¶çš„æŒ‡æ•°ä¸º1-biasï¼Œä¸ºäº†äº§ç”Ÿå¹³æ»‘çš„è¿‡æ¸¡ã€‚

### éè§„æ ¼åŒ–æµ®ç‚¹æ•°åŠèˆå…¥çš„é—®é¢˜

![image-20250222144100402](/img/image-20250222144100402.png)

èˆå…¥ï¼šå°±è¿‘èˆå…¥ï¼Œç›¸åŒ0ä¼˜å…ˆ

æŒ‡æ•°éƒ¨åˆ†è¶Šå¤§ï¼Œå¯†åº¦å˜å°ï¼Œç²¾åº¦å°±ä¼šå˜ä½

### æµ®ç‚¹æ•°çš„è¿ç®—

å…ˆæŠŠæŒ‡æ•°è®¾ç½®ç›¸åŒï¼Œå†ç›¸åŠ è¿™ä¼šå¯¼è‡´å¤§æ•°åƒæ‰å°æ•°çš„æƒ…å†µäº§ç”Ÿ

é‡‡ç”¨å¦‚ä¸‹çš„ç´¯åŠ ç®—æ³•

![image-20250222151821829](/img/image-20250222151821829.png)

æ¯”è¾ƒé—®é¢˜ï¼š0.1 + 0.2 != 0.3ï¼ˆæ— é™ä¸å¾ªç¯å°æ•°ç›¸åŠ å¯¼è‡´çš„ï¼‰

> [!NOTE]
>
> è¿˜æœ‰ä¸€ä¸ªå€¼å¾—æ³¨æ„çš„ç‚¹æ˜¯è½¬æ¢ç±»å‹æ—¶å€™çš„æœ€è¿‘å¶æ•°èˆå…¥ï¼ˆé“¶è¡Œå®¶èˆå…¥ï¼‰ï¼Œè¿™æœ‰åˆ©äºå‡å°‘ç´¯ç§¯èˆå…¥çš„è¯¯å·®ã€‚

## è¯¾åä½œä¸š

æ­¤æ—¶æˆ‘ä»¬å»åšCSAPPçš„3ä¸ªlabï¼Œå¹¶ä¸”æŠŠCSAPP2,3ç« çš„è¯¾åä¹ é¢˜éƒ½è§£å†³ä¸€éï¼ˆæˆ‘æ‡’çš„å†™ç¬¬äºŒç« äº†ï¼Œæˆ‘åªå†™ä¸€ä¸‹ç¬¬ä¸‰ç« çš„å†…å®¹ï¼‰

**1.datalab**

**2.bomblab**ï¼ˆ**gdb**çš„ä½¿ç”¨ï¼Œå¾ˆæœ‰éš¾åº¦,æˆ‘è§‰å¾—å¯ä»¥å…ˆå¤šçœ‹çœ‹ä¹¦ï¼Œåšä¸€ä¸‹ç»ƒä¹ å’Œè¯¾åä¹ é¢˜ï¼Œç†è§£ä¹‹åå†å»ä¸Šæ‰‹ï¼‰

**gdbå¸¸ç”¨æŒ‡ä»¤**ï¼ˆæ¥è‡ªhttps://arthals.ink/blog/bomb-labä½œä¸ºå‚è€ƒçš„blogï¼‰

```bash
p $rax  # æ‰“å°å¯„å­˜å™¨ rax çš„å€¼
p $rsp  # æ‰“å°æ ˆæŒ‡é’ˆçš„å€¼
p/x $rsp  # æ‰“å°æ ˆæŒ‡é’ˆçš„å€¼ï¼Œä»¥åå…­è¿›åˆ¶æ˜¾ç¤º
p/d $rsp  # æ‰“å°æ ˆæŒ‡é’ˆçš„å€¼ï¼Œä»¥åè¿›åˆ¶æ˜¾ç¤º

x/2x $rsp  # ä»¥åå…­è¿›åˆ¶æ ¼å¼æŸ¥çœ‹æ ˆæŒ‡é’ˆ %rsp æŒ‡å‘çš„å†…å­˜ä½ç½® M[%rsp] å¼€å§‹çš„ä¸¤ä¸ªå•ä½ã€‚
x/2d $rsp # ä»¥åè¿›åˆ¶æ ¼å¼æŸ¥çœ‹æ ˆæŒ‡é’ˆ %rsp æŒ‡å‘çš„å†…å­˜ä½ç½® M[%rsp] å¼€å§‹çš„ä¸¤ä¸ªå•ä½ã€‚
x/2c $rsp # ä»¥å­—ç¬¦æ ¼å¼æŸ¥çœ‹æ ˆæŒ‡é’ˆ %rsp æŒ‡å‘çš„å†…å­˜ä½ç½® M[%rsp] å¼€å§‹çš„ä¸¤ä¸ªå•ä½ã€‚
x/s $rsp # æŠŠæ ˆæŒ‡é’ˆæŒ‡å‘çš„å†…å­˜ä½ç½® M[%rsp] å½“ä½œ C é£æ ¼å­—ç¬¦ä¸²æ¥æŸ¥çœ‹ã€‚

x/b $rsp # æ£€æŸ¥æ ˆæŒ‡é’ˆæŒ‡å‘çš„å†…å­˜ä½ç½® M[%rsp] å¼€å§‹çš„ 1 å­—èŠ‚ã€‚
x/h $rsp # æ£€æŸ¥æ ˆæŒ‡é’ˆæŒ‡å‘çš„å†…å­˜ä½ç½® M[%rsp] å¼€å§‹çš„ 2 å­—èŠ‚ï¼ˆåŠå­—ï¼‰ã€‚
x/w $rsp # æ£€æŸ¥æ ˆæŒ‡é’ˆæŒ‡å‘çš„å†…å­˜ä½ç½® M[%rsp] å¼€å§‹çš„ 4 å­—èŠ‚ï¼ˆå­—ï¼‰ã€‚
x/g $rsp # æ£€æŸ¥æ ˆæŒ‡é’ˆæŒ‡å‘çš„å†…å­˜ä½ç½® M[%rsp] å¼€å§‹çš„ 8 å­—èŠ‚ï¼ˆåŒå­—ï¼‰ã€‚

info registers  # æ‰“å°æ‰€æœ‰å¯„å­˜å™¨çš„å€¼
info breakpoints  # æ‰“å°æ‰€æœ‰æ–­ç‚¹çš„ä¿¡æ¯

delete breakpoints 1  # åˆ é™¤ç¬¬ä¸€ä¸ªæ–­ç‚¹ï¼Œå¯ä»¥ç®€å†™ä¸º d 1
```

**3.attacklab**ï¼ˆæ¨¡æ‹Ÿæ”»å‡»ï¼‰

> [!NOTE]
>
> ä¸Šè¿°å·¥ä½œä¼šèŠ±è´¹å¾ˆé•¿æ—¶é—´ï¼Œä½†æ˜¯æ¬²é€Ÿåˆ™ä¸è¾¾ï¼Œå¦‚æœéš¾ä»¥ä¸‹æ‰‹ï¼Œä½ å¯ä»¥å‚è€ƒCSDIYä¸Šçš„ä¸€äº›æ¨èåšå®¢ã€‚

## é“¾æ¥ç®€å•è§£è¯»

### Static Linking

å¯ä»¥ç†è§£æ˜¯æ€ä¹ˆæŠŠä½ å†™çš„å¤šæ–‡ä»¶ç¨‹åºæ•´åˆåœ¨ä¸€èµ·è¿è¡Œã€‚

![image-20250225152305222](/img/image-20250225152305222.png)

### å¯é‡å®šä½ç›®æ ‡æ–‡ä»¶çš„åˆ†æ(Relocatable File)

å•ä¸ªæ–‡ä»¶æ±‡ç¼–ä¹‹åï¼Œåç¼€ä¸º.oçš„æ–‡ä»¶å°±æ˜¯ä¸€ä¸ªå¯é‡å®šä½ç›®æ ‡æ–‡ä»¶ã€‚

ï¼ˆç”¨ä»¥ä¸‹çš„ä¸¤ä¸ªç¨‹åºï¼‰

```bash
readelf -a main.o	//åˆ†æelfæ–‡ä»¶å†…å®¹

hexdump  -C main.o	//ç›´æ¥æŸ¥çœ‹æ–‡ä»¶çš„äºŒè¿›åˆ¶ä¿¡æ¯
```

![image-20250225155226314](/img/image-20250225155226314.png)

### ç¬¦å·è¡¨ä¿¡æ¯

![image-20250225191350912](/img/image-20250225191350912.png)

#### å¼±ç¬¦å·å’Œå¼ºç¬¦å·

![image-20250225192034009](/img/image-20250225192034009.png)

### å¯æ‰§è¡Œæ–‡ä»¶

![image-20250225192753470](/img/image-20250225192753470.png)

æŸ¥çœ‹å¯æ‰§è¡Œæ–‡ä»¶çš„Program Headerï¼ˆå¯æ‰§è¡Œæ–‡ä»¶æ˜¯æ€ä¹ˆè¢«åŠ è½½æ‰§è¡Œçš„ï¼Ÿï¼‰

```asm
Program Headers:
  Type           Offset   VirtAddr   PhysAddr   FileSiz MemSiz  Flg Align
  LOAD           0x001020 0x00800020 0x00800020 0x00198 0x00198 R E 0x1000
  LOAD           0x002000 0x00801000 0x00801000 0x00038 0x00050 RW  0x1000
  GNU_STACK      0x000000 0x00000000 0x00000000 0x00000 0x00000 RW  0x10

 Section to Segment mapping:
  Segment Sections...
   00     .text .rodata 
   01     .data .bss 
   02     
```

### é™æ€é“¾æ¥çš„è¿‡ç¨‹

![image-20250225194125819](/img/image-20250225194125819.png)

```c
/* Simple linker script for os user-level programs.
   See the GNU ld 'info' manual ("info ld") to learn the syntax. */
//ä¸€ä¸ªç®€å•çš„linkerè„šæœ¬
OUTPUT_FORMAT("elf32-i386", "elf32-i386", "elf32-i386")	//è¾“å‡ºæ ¼å¼
OUTPUT_ARCH(i386)	//æ¶æ„ç±»å‹
ENTRY(main)	//ç¨‹åºçš„å…¥å£ç‚¹ï¼ˆmainå‡½æ•°ï¼‰

SECTIONS {
    /* Load programs at this address: "." means the current address */
    //åœ¨è¿™ä¸ªåœ°å€å¯¹ç¨‹åºè¿›è¡ŒåŠ è½½
    . = 0x800020;
	
    //ä»¥ä¸‹éƒ½æ˜¯æŠŠæ¯ä¸ªç›®æ ‡æ–‡ä»¶ä¸­çš„ç›¸åŒçš„æ®µåˆå¹¶åˆ°æ–°çš„æ®µ
    .text : {
        *(.text .stub .text.* .gnu.linkonce.t.*)
    }
    
    PROVIDE(etext = .); /* Define the 'etext' symbol to this value */
    
    .rodata : {
        *(.rodata .rodata.* .gnu.linkonce.r.*)
    }
    
    /* Adjust the address for the data segment to the next page */
    //è½¬é¡µè¿›è¡Œå­˜å‚¨ï¼Œä»¥ä¸Šçš„é¡µå°±å¯ä»¥è®¾ç½®æˆroçš„ä¸€ä¸ªé¡µ
    . = ALIGN(0x1000);
    
    .data : {
        *(.data)
    }
    
    //è®°å½•ä¸‹æ¥ï¼ŒæŠŠ.bssæ®µè®¾ç½®æˆ0
    PROVIDE(edata = .);
    
    .bss : {
        *(.bss)
    }
    
    PROVIDE(end = .);
    
    /DISCARD/ : {
        *(.eh_frame .note.GNU-stack .comment)
    }

}
```

### é‡å®šä½ä¿¡æ¯

![image-20250225200024731](/img/image-20250225200024731.png)
